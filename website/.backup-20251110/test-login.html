<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Test - Ace#1</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
        }
        .test-section h2 {
            margin-top: 0;
            color: #3498db;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Login & Lockout Test</h1>

        <div class="test-section">
            <h2>Step 1: Create Test User</h2>
            <p>First, let's create a test user with email: <strong>hello@ace1.in</strong></p>
            
            <div class="form-group">
                <label>Password for test user:</label>
                <input type="password" id="createPassword" value="testpass123" placeholder="Enter password">
            </div>
            
            <button onclick="createTestUser()">Create Test User</button>
            <button onclick="clearTestUser()">Clear Test User</button>
            <div id="createResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>Step 2: Test Login</h2>
            <p>Test logging in with correct credentials</p>
            
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="loginEmail" value="hello@ace1.in">
            </div>
            
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="loginPassword" value="testpass123">
            </div>
            
            <button onclick="testLogin()">Test Login</button>
            <button onclick="testLogout()">Logout</button>
            <div id="loginResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>Step 3: Test Lockout (5 Failed Attempts)</h2>
            <p>This will try 5 wrong passwords to trigger the lockout mechanism</p>
            
            <button onclick="testLockout()">Trigger Lockout (5 Failed Attempts)</button>
            <button onclick="clearLockout()">Clear Lockout Data</button>
            <div id="lockoutResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>Step 4: Check Lockout Status</h2>
            <p>Verify that the account is locked after failed attempts</p>
            
            <button onclick="checkLockoutStatus()">Check Lockout Status</button>
            <button onclick="viewAllUsers()">View All Users</button>
            <button onclick="viewLocalStorage()">View localStorage</button>
            <div id="statusResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <!-- Security Scripts (Load in correct order!) -->
    <script src="/assets/js/crypto-utils.js"></script>
    <script src="/assets/js/env-config.js"></script>
    <script src="/assets/js/auth.js"></script>

    <script>
        // Wait for auth system to initialize
        window.addEventListener('load', () => {
            setTimeout(() => {
                showResult('createResult', 'Ready to test! Auth system loaded.', 'info');
            }, 500);
        });

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        async function createTestUser() {
            const password = document.getElementById('createPassword').value;
            
            if (!password) {
                showResult('createResult', 'Please enter a password!', 'error');
                return;
            }

            try {
                const result = await window.auth.register({
                    email: 'hello@ace1.in',
                    password: password,
                    firstName: 'Test',
                    lastName: 'User',
                    phone: '1234567890'
                });

                if (result.success) {
                    showResult('createResult', `‚úÖ SUCCESS!\n${result.message}\n\nUser created with:\nEmail: hello@ace1.in\nPassword: ${password}`, 'success');
                    // Logout after creation
                    await testLogout();
                } else {
                    showResult('createResult', `‚ùå FAILED!\n${result.message}`, 'error');
                }
            } catch (error) {
                showResult('createResult', `‚ùå ERROR!\n${error.message}`, 'error');
            }
        }

        async function clearTestUser() {
            try {
                // Get all users
                const users = await window.auth.loadUsers();
                
                // Filter out the test user
                window.auth.users = users.filter(u => u.email !== 'hello@ace1.in');
                
                // Save updated user list
                await window.auth.saveUsers();
                
                // Logout if logged in as this user
                if (window.auth.currentUser?.email === 'hello@ace1.in') {
                    localStorage.removeItem('ace1_session');
                    window.auth.currentUser = null;
                }
                
                showResult('createResult', '‚úÖ Test user cleared!', 'success');
            } catch (error) {
                showResult('createResult', `‚ùå ERROR!\n${error.message}`, 'error');
            }
        }

        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const result = await window.auth.login(email, password);

                if (result.success) {
                    showResult('loginResult', `‚úÖ LOGIN SUCCESS!\n${result.message}\n\nUser: ${result.user.email}\nName: ${result.user.firstName} ${result.user.lastName}`, 'success');
                } else {
                    showResult('loginResult', `‚ùå LOGIN FAILED!\n${result.message}`, 'error');
                }
            } catch (error) {
                showResult('loginResult', `‚ùå ERROR!\n${error.message}`, 'error');
            }
        }

        async function testLogout() {
            try {
                localStorage.removeItem('ace1_session');
                window.auth.currentUser = null;
                window.auth.updateUI();
                showResult('loginResult', '‚úÖ Logged out successfully!', 'info');
            } catch (error) {
                showResult('loginResult', `‚ùå ERROR!\n${error.message}`, 'error');
            }
        }

        async function testLockout() {
            const email = document.getElementById('loginEmail').value;
            let results = 'üîí Testing lockout mechanism...\n\n';

            showResult('lockoutResult', results + 'Starting 5 failed login attempts...', 'info');

            // First, make sure we're logged out
            await testLogout();

            // Clear any existing lockout
            if (window.configManager) {
                window.configManager.clearFailedLogins(email);
            }

            // Try 5 wrong passwords
            for (let i = 1; i <= 5; i++) {
                await new Promise(resolve => setTimeout(resolve, 100)); // Small delay

                const result = await window.auth.login(email, 'wrongpassword' + i);
                
                results += `\nAttempt ${i}: ${result.message}`;
                showResult('lockoutResult', results, 'warning');
            }

            // Try one more time to verify lockout
            await new Promise(resolve => setTimeout(resolve, 100));
            const finalResult = await window.auth.login(email, 'testpass123');
            
            results += `\n\n6th attempt (correct password): ${finalResult.message}`;
            
            if (finalResult.message.includes('locked')) {
                results += '\n\n‚úÖ LOCKOUT WORKING! Account is locked for 15 minutes.';
                showResult('lockoutResult', results, 'success');
            } else {
                results += '\n\n‚ùå LOCKOUT FAILED! Account should be locked but isn\'t.';
                showResult('lockoutResult', results, 'error');
            }
        }

        function clearLockout() {
            const email = document.getElementById('loginEmail').value;
            
            if (window.configManager) {
                window.configManager.clearFailedLogins(email);
                showResult('lockoutResult', '‚úÖ Lockout data cleared! You can try logging in again.', 'success');
            } else {
                showResult('lockoutResult', '‚ùå Config manager not loaded!', 'error');
            }
        }

        function checkLockoutStatus() {
            const email = document.getElementById('loginEmail').value;
            let status = 'üìä Lockout Status:\n\n';

            if (window.configManager) {
                const isLocked = window.configManager.isLockedOut(email);
                const lockoutKey = `lockout_${email}`;
                const lockoutData = localStorage.getItem(lockoutKey);

                status += `Email: ${email}\n`;
                status += `Is Locked: ${isLocked ? 'üîí YES' : 'üîì NO'}\n\n`;

                if (lockoutData) {
                    const data = JSON.parse(lockoutData);
                    status += `Failed Attempts: ${data.attempts}\n`;
                    
                    if (data.lockedUntil > 0) {
                        const remainingTime = Math.max(0, data.lockedUntil - Date.now());
                        const minutes = Math.floor(remainingTime / 60000);
                        const seconds = Math.floor((remainingTime % 60000) / 1000);
                        status += `Locked Until: ${new Date(data.lockedUntil).toLocaleTimeString()}\n`;
                        status += `Time Remaining: ${minutes}m ${seconds}s\n`;
                    }
                } else {
                    status += 'No lockout data found.\n';
                }

                showResult('statusResult', status, isLocked ? 'warning' : 'success');
            } else {
                showResult('statusResult', '‚ùå Config manager not loaded!', 'error');
            }
        }

        async function viewAllUsers() {
            try {
                const users = await window.auth.loadUsers();
                let output = `üìã All Users (${users.length}):\n\n`;

                if (users.length === 0) {
                    output += 'No users found.\n\nCreate a test user first!';
                } else {
                    users.forEach((user, index) => {
                        output += `${index + 1}. ${user.email}\n`;
                        output += `   Name: ${user.firstName} ${user.lastName}\n`;
                        output += `   ID: ${user.id}\n`;
                        output += `   Created: ${new Date(user.createdAt).toLocaleString()}\n\n`;
                    });
                }

                showResult('statusResult', output, 'info');
            } catch (error) {
                showResult('statusResult', `‚ùå ERROR!\n${error.message}`, 'error');
            }
        }

        function viewLocalStorage() {
            let output = 'üíæ localStorage Contents:\n\n';
            
            const keys = ['ace1_users', 'ace1_session', 'ace1_cart', 'ace1_secure_storage_key', 'ace1_cart_encryption_key'];
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    const preview = value.length > 100 ? value.substring(0, 100) + '...' : value;
                    output += `${key}:\n`;
                    output += `  Length: ${value.length} chars\n`;
                    output += `  Preview: ${preview}\n`;
                    output += `  Encrypted: ${value.startsWith('{') ? '‚ùå NO (plain JSON)' : '‚úÖ YES'}\n\n`;
                } else {
                    output += `${key}: (empty)\n\n`;
                }
            });

            // Check for lockout keys
            const lockoutKeys = Object.keys(localStorage).filter(k => k.startsWith('lockout_'));
            if (lockoutKeys.length > 0) {
                output += '\nüîí Lockout Data:\n';
                lockoutKeys.forEach(key => {
                    const data = JSON.parse(localStorage.getItem(key));
                    output += `  ${key}: ${data.attempts} attempts\n`;
                });
            }

            showResult('statusResult', output, 'info');
        }
    </script>
</body>
</html>
